<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ä¼æ¥­çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆäººäº‹çµŒæ¸ˆå­¦ï¼‰</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      background: #e0e7f0;
      user-select: none;
    }
    #ui {
      width: 280px;
      background: rgba(255,255,255,0.95);
      padding: 16px;
      box-sizing: border-box;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #orgPanel {
      width: 300px;
      background: rgba(255,255,255,0.95);
      padding: 16px;
      box-sizing: border-box;
      border-left: 1px solid #ccc;
      font-size: 14px;
    }
    #orgPanel h4 {
      margin: 12px 0 4px;
    }
    #orgPanel ul {
      padding-left: 18px;
      margin: 4px 0;
    }
    #orgPanel li {
      margin-bottom: 4px;
    }
    h3 {
      margin: 0 0 8px 0;
      font-weight: bold;
      font-size: 18px;
    }
    .stat {
      font-size: 14px;
      margin: 4px 0;
    }
    button {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #999;
      border-radius: 4px;
      background: #f8f8f8;
      transition: background 0.2s;
    }
    button:hover {
      background: #e0e0e0;
    }
    button.selected {
      background: #4a90e2;
      color: white;
      border-color: #357ABD;
    }
    #buildStatus {
      font-size: 13px;
      color: #333;
      min-height: 20px;
      margin-top: 4px;
      min-height: 24px;
    }
    #gameOver {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
      text-align: center;
      font-size: 18px;
    }
    #gameOver h2 {
      margin-bottom: 12px;
      font-size: 28px;
    }
    #gameOver ul {
      list-style: none;
      padding: 0;
      margin: 12px 0 20px 0;
      max-width: 200px;
      text-align: left;
      font-size: 16px;
    }
    #gameOver ul li {
      margin-bottom: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      background: rgba(255,255,255,0.15);
      font-weight: bold;
    }
    #gameOver ul li:nth-child(1) {
      background: linear-gradient(90deg, #ffd700, #ffec8b);
      color: #333;
    }
    #gameOver ul li:nth-child(2) {
      background: linear-gradient(90deg, #c0c0c0, #e0e0e0);
      color: #333;
    }
    #gameOver ul li:nth-child(3) {
      background: linear-gradient(90deg, #cd7f32, #e6c19c);
      color: #333;
    }
    #gameOver button {
      width: auto;
      margin: 6px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #logPanel {
    flex: 1;
    background: #eef2f7;
    padding: 16px;
    box-sizing: border-box;
    overflow-y: auto;
    font-size: 14px;
  }

  #eventLog {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .logItem {
    background: white;
    border-left: 4px solid #4a90e2;
    padding: 8px 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .logItem.good { border-left-color: #2ecc71; }
  .logItem.bad { border-left-color: #e74c3c; }
  .logItem.info { border-left-color: #7f8c8d; }

  .logYear {
    font-size: 11px;
    color: #666;
  }
  /* =========================
   Modern UI Override
   ========================= */

body {
  background: linear-gradient(135deg, #1f2933, #111827);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* Left panel */
#ui {
  background: #ffffff;
  box-shadow: 4px 0 20px rgba(0,0,0,0.15);
  border-radius: 0 16px 16px 0;
}

/* Stats dashboard */
.stat {
  display: flex;
  justify-content: space-between;
}
.stat span {
  font-weight: 700;
  color: #2563eb;
}

/* Buttons */
button {
  border-radius: 10px;
  background: #2563eb;
  color: white;
  border: none;
}
button:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

/* Organization panel */
#orgPanel {
  background: #ffffff;
  box-shadow: -4px 0 20px rgba(0,0,0,0.15);
  border-radius: 16px 0 0 16px;
}

/* Log feed */
#logPanel {
  background: #f9fafb;
}
.logItem {
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  border-left-width: 5px;
}

/* Table */
#roleWageTable th,
#roleWageTable td {
  border: none;
  padding: 6px;
}
#roleWageTable tr:nth-child(even) {
  background: #f1f5f9;
}

/* Game over */
#gameOver {
  backdrop-filter: blur(6px);
}
#gameOver h2 {
  color: #fde047;
}
  </style>
</head>
<body>

<div id="startScreen" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,0.8);
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:2000;
  font-size:18px;
">
  <h2 style="font-size:32px;margin-bottom:16px;">ä¼æ¥­çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆäººäº‹çµŒæ¸ˆå­¦ï¼‰</h2>
  <div style="margin-bottom:20px;">
    <strong>ãƒ—ãƒ¬ã‚¤æœŸé–“</strong><br>
    <label><input type="radio" name="duration" value="5" checked> 5å¹´</label>
    <label><input type="radio" name="duration" value="10"> 10å¹´</label>
    <label><input type="radio" name="duration" value="20"> 20å¹´</label>
  </div>
  <button id="startGameBtn" style="font-size:18px;padding:10px 24px;">
    ã‚²ãƒ¼ãƒ é–‹å§‹
  </button>
</div>

<div id="ui">
  <h3>ä¼æ¥­çµŒå–¶ãƒ‘ãƒãƒ«</h3>
  <div class="stat">å¹´: <span id="year">1</span></div>
  <div class="stat">æ®‹å­˜æœŸé–“: <span id="remainingYears"></span></div>
  <div class="stat">äºˆç®—: <span id="budget">1000</span></div>
  <div class="stat">é¡§å®¢åŸºç›¤: <span id="customerBase">0</span></div>
  <div class="stat">å¾“æ¥­å“¡æ•°: <span id="employeeCount">0</span></div>
  <div class="stat">åˆ©ç›Š: <span id="profit">0</span></div>
  <div class="stat">ç´¯ç©åˆ©ç›Šï¼ˆã‚¹ã‚³ã‚¢ï¼‰: <span id="score">0</span></div>

  <h3>äººææ¡ç”¨</h3>
  <button id="btn-manufacturing" onclick="selectHire('manufacturing')">è£½é€ æ‹…å½“ã‚’æ¡ç”¨</button>
  <button id="btn-sales" onclick="selectHire('sales')">å–¶æ¥­æ‹…å½“ã‚’æ¡ç”¨</button>
  <button id="btn-accounting" onclick="selectHire('accounting')">çµŒç†æ‹…å½“ã‚’æ¡ç”¨</button>
  <button id="btn-legal" onclick="selectHire('legal')">æ³•å‹™æ‹…å½“ã‚’æ¡ç”¨</button>

  <select id="wageSelect" style="margin-top:8px;">
    <option value="low">ä½è³ƒé‡‘ï¼ˆ50ï¼‰</option>
    <option value="mid" selected>æ¨™æº–è³ƒé‡‘ï¼ˆ100ï¼‰</option>
    <option value="high">é«˜è³ƒé‡‘ï¼ˆ200ï¼‰</option>
  </select>

  <div id="hireStatus" style="font-size:13px;color:#333;min-height:24px;margin-top:4px;"></div>

  <button id="nextYearBtn" onclick="nextYear()">æ¬¡ã®å¹´ã¸ â–¶</button>
</div>

<div id="orgPanel">
  <h3>ç¾åœ¨ã®çµ„ç¹”æ§‹æˆ</h3>
  <div style="font-size:12px;color:#555;margin-bottom:8px;">
  å„è·ç¨®ã§é«˜è³ƒé‡‘ï¼ˆ200ï¼‰ãŒç´„20%ä»¥ä¸Šã„ã‚‹ã¨ã€å­¦ç¿’åŠ¹æœã«ã‚ˆã‚Š
  åŒè·ç¨®ã®ç”Ÿç”£æ€§ãŒä¸Šæ˜‡ã—ã¾ã™ã€‚
  </div>
  <div style="font-size:12px;color:#555;">
  æ¡ç”¨ã—ãŸå¹´ã¯æŠ•è³‡æœŸé–“ã¨ã¿ãªã—ã€è³ƒé‡‘ã¯ç¿Œå¹´ã‹ã‚‰ç™ºç”Ÿã—ã¾ã™ã€‚
  </div>
  <div id="orgSummary"></div>
  <h4>è·ç¨®åˆ¥å†…è¨³</h4>
  <ul id="byRole"></ul>
  <h4>è³ƒé‡‘åˆ¥å†…è¨³</h4>
  <ul id="byWage"></ul>
  <h4>è·ç¨®Ã—è³ƒé‡‘æ§‹æˆ</h4>
  <table id="roleWageTable" border="1" style="width:100%; font-size:12px; border-collapse:collapse;">
    <thead>
      <tr>
        <th>è·ç¨®</th>
        <th>ä½ï¼ˆ50ï¼‰</th>
        <th>ä¸­ï¼ˆ100ï¼‰</th>
        <th>é«˜ï¼ˆ200ï¼‰</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h4>è§£é›‡</h4>
  <select id="fireSelect"></select>
  <button id="fireBtn">è§£é›‡ã™ã‚‹ï¼ˆã‚³ã‚¹ãƒˆ50ï¼‰</button>
</div>

<div id="logPanel">
  <h3>ä¼æ¥­ã®å‹•å‘</h3>
  <div id="eventLog"></div>
</div>

<div id="gameOver" role="dialog" aria-modal="true" aria-labelledby="gameOverTitle">
  <h2 id="gameOverTitle">ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
  <div>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore"></span></div>
  <div id="scoreHint" style="margin-top:16px;font-size:16px;color:#ffe;"> </div>
  <h3 style="margin-top:20px;font-size:22px;color:#ffeb3b;">
  ğŸ† ãƒã‚¤ã‚¹ã‚³ã‚¢ TOP 5
  </h3>
  <ul id="scoreHistoryList"></ul>
  <div style="font-size:14px;margin-top:8px;color:#ddd;">
  ã“ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã€ã“ã‚Œã¾ã§ã«ã‚ãªãŸãŒç¯‰ã„ãŸä¼æ¥­ã®æˆæœã§ã™ã€‚
  äººæé…ç½®ã¨è³ƒé‡‘æˆ¦ç•¥ã®å·¥å¤«ãŒã€é•·æœŸçš„ãªåˆ©ç›Šã‚’å·¦å³ã—ã¾ã™ã€‚
  </div>
  <div>
    <button id="btnRestart">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    <button id="btnResetScores">ã‚¹ã‚³ã‚¢å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<script>
// ==========================
// ä¼æ¥­çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æœ¬ä½“
// ==========================
(() => {
// --- çŠ¶æ…‹å¤‰æ•° ---
let year = 1;
let MAX_YEAR = 5;
let budget = 1000;
let profit = 0;
let totalProfit = 0;
let customerBase = 0; // é¡§å®¢åŸºç›¤ï¼ˆã‚¹ãƒˆãƒƒã‚¯ï¼‰
let employees = []; // { role, wage, productivity, tenure }
let gameOver = false;

// è·ç¨®å®šç¾©
const ROLES = {
  manufacturing: { base: 40, label: "è£½é€ " },
  sales: { base: 30, label: "å–¶æ¥­" },
  accounting: { base: 20, label: "çµŒç†" },
  legal: { base: 15, label: "æ³•å‹™" }
};

// å­¦ç¿’åŠ¹æœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
const LEARNING_THRESHOLD = 0.2; // é«˜è³ƒé‡‘æ¯”ç‡20%
const LEARNING_BONUS = 0.15;    // ç”Ÿç”£æ€§+15%

// è³ƒé‡‘å€ç‡
function wageMultiplier(wage) {
  if (wage === 'low') return 0.6;
  if (wage === 'mid') return 1.0;
  if (wage === 'high') return 1.4;
  return 1.0;
}
function wageCost(wage) {
  if (wage === 'low') return 50;
  if (wage === 'mid') return 100;
  if (wage === 'high') return 200;
  return 100;
}

// é›¢è·ç¢ºç‡
function quitProbability(wage) {
  if (wage === 'low') return 0.30;
  if (wage === 'mid') return 0.10;
  if (wage === 'high') return 0.02;
  return 0.1;
}

// --- ãƒ­ã‚°ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ---
const HIRE_MESSAGES = {
  manufacturing: {
    low: [
      "è£½é€ ç¾å ´ã«æ–°äººãŒåŠ ã‚ã£ãŸã€‚ã¾ãšã¯åŸºæœ¬ä½œæ¥­ã‹ã‚‰è¦šãˆã¦ã‚‚ã‚‰ãŠã†ã€‚"
    ],
    mid: [
      "è£½é€ è·ã®æ–°å…¥ç¤¾å“¡ãŒå…¥ç¤¾ã—ãŸã€‚ã‚„ã‚‹æ°—ã¯ã‚ã‚Šãã†ã ã€‚"
    ],
    high: [
      "ä»–ç¤¾ã§å®Ÿç¸¾ã®ã‚ã‚‹å„ªç§€ãªè£½é€ æ‹…å½“ã‚’ä¸­é€”æ¡ç”¨ã§ããŸã€‚",
      "ç¾å ´æ”¹å–„ã®çµŒé¨“ã‚’æŒã¤å³æˆ¦åŠ›ã®è£½é€ äººæãŒåŠ ã‚ã£ãŸã€‚"
    ]
  },
  sales: {
    low: [
      "å–¶æ¥­éƒ¨ã«æ–°äººãŒé…å±ã•ã‚ŒãŸã€‚ã¾ãšã¯å…ˆè¼©åŒè¡Œã‹ã‚‰å§‹ã‚ã¦ã‚‚ã‚‰ãŠã†ã€‚"
    ],
    mid: [
      "å–¶æ¥­è·ã®æ–°å…¥ç¤¾å“¡ãŒå…¥ç¤¾ã—ãŸã€‚ã‚„ã‚‹æ°—ã¯ååˆ†ã‚ã‚Šãã†ã ã€‚"
    ],
    high: [
      "å¤§å£é¡§å®¢ã‚’æ‹…å½“ã—ã¦ããŸå„ªç§€ãªå–¶æ¥­ã‚’ç²å¾—ã§ããŸã€‚",
      "ä»–ç¤¾ã§æˆæœã‚’å‡ºã—ã¦ããŸå³æˆ¦åŠ›å–¶æ¥­ãŒãƒãƒ¼ãƒ ã«åŠ ã‚ã£ãŸã€‚"
    ]
  },
  accounting: {
    low: [
      "çµŒç†éƒ¨ã«æ–°äººãŒå…¥ã£ãŸã€‚åŸºç¤æ¥­å‹™ã‚’è¦šãˆã¦ã‚‚ã‚‰ãŠã†ã€‚"
    ],
    mid: [
      "çµŒç†æ‹…å½“ã‚’æ¡ç”¨ã—ãŸã€‚å …å®Ÿã«æ¥­å‹™ã‚’ã“ãªã—ã¦ãã‚Œãã†ã ã€‚"
    ],
    high: [
      "ç®¡ç†ä½“åˆ¶ã‚’å¼·åŒ–ã§ãã‚‹çµŒé¨“è±Šå¯ŒãªçµŒç†äººæã‚’è¿ãˆå…¥ã‚ŒãŸã€‚"
    ]
  },
  legal: {
    low: [
      "æ³•å‹™éƒ¨ã«æ–°äººãŒåŠ ã‚ã£ãŸã€‚ã¾ãšã¯å¥‘ç´„ãƒã‚§ãƒƒã‚¯ã®è£œåŠ©ã‹ã‚‰ã ã€‚"
    ],
    mid: [
      "æ³•å‹™æ‹…å½“ã‚’æ¡ç”¨ã—ãŸã€‚ç¤¾å†…ãƒ«ãƒ¼ãƒ«ã®æ•´å‚™ãŒé€²ã¿ãã†ã ã€‚"
    ],
    high: [
      "ä»–ç¤¾ã§æ³•å‹™è²¬ä»»è€…ã‚’å‹™ã‚ãŸçµŒé¨“è€…ã‚’æ¡ç”¨ã§ããŸã€‚",
      "ãƒªã‚¹ã‚¯ç®¡ç†ã«å¼·ã„æ³•å‹™ã®å°‚é–€å®¶ãŒåŠ ã‚ã£ãŸã€‚"
    ]
  }
};

// --- UIå‚ç…§ ---
const yearElem = document.getElementById('year');
const remainingYearsElem = document.getElementById('remainingYears');
const budgetElem = document.getElementById('budget');
const customerBaseElem = document.getElementById('customerBase');
const employeeCountElem = document.getElementById('employeeCount');
const profitElem = document.getElementById('profit');
const scoreElem = document.getElementById('score');
const hireStatusElem = document.getElementById('hireStatus');
const nextYearBtn = document.getElementById('nextYearBtn');
const eventLogElem = document.getElementById('eventLog');

// --- ä¼æ¥­å‹•å‘ãƒ­ã‚° ---
function addLog(message, type = 'info') {
  const div = document.createElement('div');
  div.className = `logItem ${type}`;
  div.innerHTML = `
    <div class="logYear">å¹´ ${year}</div>
    <div>${message}</div>
  `;
  eventLogElem.prepend(div);
}

const btnManufacturing = document.getElementById('btn-manufacturing');
const btnSales = document.getElementById('btn-sales');
const btnAccounting = document.getElementById('btn-accounting');
const btnLegal = document.getElementById('btn-legal');
const wageSelect = document.getElementById('wageSelect');

const fireSelect = document.getElementById('fireSelect');
const fireBtn = document.getElementById('fireBtn');

const gameOverElem = document.getElementById('gameOver');
const finalScoreElem = document.getElementById('finalScore');
const scoreHistoryList = document.getElementById('scoreHistoryList');
const btnRestart = document.getElementById('btnRestart');
const btnResetScores = document.getElementById('btnResetScores');
const scoreHintElem = document.getElementById('scoreHint');

const orgSummaryElem = document.getElementById('orgSummary');
const byRoleElem = document.getElementById('byRole');
const byWageElem = document.getElementById('byWage');
const roleWageTableBody = document.querySelector('#roleWageTable tbody');

// --- UIæ›´æ–° ---
function updateUI() {
  yearElem.textContent = year;
  remainingYearsElem.textContent = Math.max(0, (MAX_YEAR - year + 1));
  budgetElem.textContent = budget;
  customerBaseElem.textContent = customerBase;
  employeeCountElem.textContent = employees.length;
  profitElem.textContent = profit;
  scoreElem.textContent = totalProfit;
  nextYearBtn.disabled = gameOver;
  btnManufacturing.disabled = gameOver;
  btnSales.disabled = gameOver;
  btnAccounting.disabled = gameOver;
  btnLegal.disabled = gameOver;
  wageSelect.disabled = gameOver;
  fireSelect.disabled = gameOver;
  fireBtn.disabled = gameOver;

  renderOrgPanel();
}

// --- æ¡ç”¨å‡¦ç† ---
function selectHire(role) {
  if (gameOver) return;
  const wage = wageSelect.value;
  hire(role, wage);
}
window.selectHire = selectHire;

function hire(role, wage) {
  const cost = wageCost(wage);
  if (budget < cost) {
    hireStatusElem.textContent = 'äºˆç®—ä¸è¶³ã§æ¡ç”¨ã§ãã¾ã›ã‚“ã€‚';
    return;
  }
  budget -= cost;
  employees.push({
    role,
    wage,
    productivity: ROLES[role].base * wageMultiplier(wage),
    tenure: 0   // åœ¨è·å¹´æ•°ï¼ˆæ¡ç”¨å¹´ã¯0ï¼‰
  });
  hireStatusElem.textContent = `${ROLES[role].label}ï¼ˆ${wageLabel(wage)}ï¼‰ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚`;
  const msgs = HIRE_MESSAGES[role][wage];
  const msg = msgs[Math.floor(Math.random() * msgs.length)];
  addLog(msg, wage === 'high' ? 'good' : 'info');
  updateUI();
}
function wageLabel(wage) {
  if (wage === 'low') return 'ä½è³ƒé‡‘ï¼ˆ50ï¼‰';
  if (wage === 'mid') return 'æ¨™æº–è³ƒé‡‘ï¼ˆ100ï¼‰';
  if (wage === 'high') return 'é«˜è³ƒé‡‘ï¼ˆ200ï¼‰';
  return wage;
}

// --- è·ç¨®ãƒ»è³ƒé‡‘åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ ---
function buildStats() {
  let stats = {
    manufacturing: { low: 0, mid: 0, high: 0 },
    sales: { low: 0, mid: 0, high: 0 },
    accounting: { low: 0, mid: 0, high: 0 },
    legal: { low: 0, mid: 0, high: 0 }
  };
  employees.forEach(e => {
    stats[e.role][e.wage]++;
  });
  return stats;
}

// --- èƒ½åŠ›å€¤ï¼ˆç”Ÿç”£/è²©å£²ï¼‰ã¨ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹æŒ‡æ¨™ ---
function computeCapabilities(stats) {
  const productionCap =
    40 * stats.manufacturing.low +
    60 * stats.manufacturing.mid +
    90 * stats.manufacturing.high;

  let salesCap =
    30 * stats.sales.low +
    50 * stats.sales.mid +
    80 * stats.sales.high;

  const totalSales = stats.sales.low + stats.sales.mid + stats.sales.high;
  const highShareSales = totalSales > 0 ? (stats.sales.high / totalSales) : 0;

  if (totalSales > 0 && highShareSales >= LEARNING_THRESHOLD) {
    salesCap *= (1 + LEARNING_BONUS);
  }

  const backOfficeCount =
    stats.accounting.low + stats.accounting.mid + stats.accounting.high +
    stats.legal.low + stats.legal.mid + stats.legal.high;

  let backOfficeMult = 1.0;
  if (backOfficeCount >= 2) backOfficeMult = 1.1;
  if (backOfficeCount >= 4) backOfficeMult = 1.2;

  return { productionCap, salesCap, totalSales, backOfficeCount, backOfficeMult };
}

const ACQUISITION_RATE = 0.08;
const BASE_ARPU = 40;
const CHURN_BASE = 0.05;

function computeChurnRate(backOfficeCount) {
  if (backOfficeCount >= 4) return 0.02;
  if (backOfficeCount >= 2) return 0.03;
  return CHURN_BASE;
}

function acquireCustomers(caps) {
  const bottleneck = Math.min(caps.productionCap, caps.salesCap);
  return Math.max(0, Math.floor(ACQUISITION_RATE * bottleneck * caps.backOfficeMult));
}

function computeARPU(stats, caps) {
  const totalSales = caps.totalSales;
  if (totalSales === 0) return 0;
  const quality = (1 * stats.sales.mid + 2 * stats.sales.high) / totalSales;
  return Math.floor(BASE_ARPU * (1.0 + 0.25 * quality));
}

function computeGrossRevenue(customerBaseNow, arpu) {
  return Math.floor(customerBaseNow * arpu);
}

function nextYear() {
  if (gameOver) return;

  if (year > MAX_YEAR) {
    showGameOver();
    return;
  }

  // ===== å¹´æœ«æ±ºç®— =====
  const stats = buildStats();
  const caps = computeCapabilities(stats);

  const churnRate = computeChurnRate(caps.backOfficeCount);
  const churn = Math.floor(customerBase * churnRate);
  customerBase = Math.max(0, customerBase - churn);

  const newCustomers = acquireCustomers(caps);
  customerBase += newCustomers;

  const arpu = computeARPU(stats, caps);
  const grossRevenue = computeGrossRevenue(customerBase, arpu);

  const totalWageCost = employees
    .filter(e => e.tenure >= 1)
    .reduce((s,e)=>s + wageCost(e.wage), 0);

  profit = grossRevenue - totalWageCost;
  totalProfit += profit;
  budget += profit;

  hireStatusElem.textContent =
    `æ–°è¦é¡§å®¢:${newCustomers} / é¡§å®¢åŸºç›¤:${customerBase} / å˜ä¾¡:${arpu} / å£²ä¸Š:${grossRevenue} / äººä»¶è²»:${totalWageCost} / ç´”åˆ©ç›Š:${profit}`;

  addLog(
    `å¹´æ¬¡æ±ºç®—ãƒ¬ãƒãƒ¼ãƒˆï¼š<br>
   ãƒ»æ—¢å­˜é¡§å®¢æ•°ï¼š${customerBase - newCustomers}ï¼ˆé›¢è„±ç‡ ${(churnRate*100).toFixed(1)}%ï¼‰<br>
   ãƒ»æ–°è¦é¡§å®¢ç²å¾—ï¼š${newCustomers}ä»¶ï¼ˆå–¶æ¥­è· ${caps.totalSales}äººï¼‰<br>
   ãƒ»å¹³å‡å—æ³¨å˜ä¾¡ï¼š${arpu}<br>
   ãƒ»å£²ä¸Šé«˜ï¼š${grossRevenue}<br>
   ãƒ»äººä»¶è²»ï¼š${totalWageCost}<br>
   ãƒ»ç´”åˆ©ç›Šï¼š${profit}`,
    profit >= 0 ? 'good' : 'bad'
  );

  if (caps.totalSales === 0) {
    addLog("å–¶æ¥­äººå“¡ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€æ–°è¦é¡§å®¢ã‚’ç²å¾—ã§ãã¦ã„ãªã„ã€‚å–¶æ¥­æ¡ç”¨ã‚’æ¤œè¨ã™ã¹ãã ã€‚", 'info');
  }
  if (caps.backOfficeCount < 2) {
    addLog("ç®¡ç†éƒ¨é–€ãŒæ‰‹è–„ã ã€‚é›¢è·ã‚„é¡§å®¢é›¢è„±ã®ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã€‚", 'info');
  }
  if (profit > 0 && caps.totalSales > 0) {
    addLog("ç¾åœ¨ã®çµ„ç¹”æ§‹æˆã¯æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã€‚ã©ã®éƒ¨é–€ã‚’å¼·åŒ–ã™ã‚‹ã¨æˆé•·ãŒåŠ é€Ÿã™ã‚‹ã‹è€ƒãˆã‚ˆã†ã€‚", 'info');
  }

  // ===== å¹´æ›¿ã‚ã‚Š =====
  year++;
  employees.forEach(e => e.tenure++);

  let quitLog = [];
  employees = employees.filter(e => {
    if (Math.random() < quitProbability(e.wage)) {
      quitLog.push(`${ROLES[e.role].label}ï¼ˆ${wageLabel(e.wage)}ï¼‰`);
      return false;
    }
    return true;
  });
  if (quitLog.length > 0) {
    hireStatusElem.textContent += ` / é›¢è·:${quitLog.join('ã€')}`;
    quitLog.forEach(msg => {
      addLog(`${msg} ãŒé€€è·ã—ã¦ã—ã¾ã£ãŸã€‚å¯¾ç­–ã‚’è€ƒãˆãªã„ã¨ã„ã‘ãªã„ã€‚`, 'bad');
    });
  }

  updateUI();

  if (year > MAX_YEAR) {
    showGameOver();
  }
}
window.nextYear = nextYear;

// --- è§£é›‡å‡¦ç† ---
fireBtn.addEventListener('click', () => {
  if (employees.length === 0) return;
  const idx = parseInt(fireSelect.value, 10);
  if (isNaN(idx)) return;
  const cost = 50;
  if (budget < cost) {
    alert('è§£é›‡ã‚³ã‚¹ãƒˆã‚’æ”¯æ‰•ãˆã¾ã›ã‚“');
    return;
  }
  const fired = employees.splice(idx,1)[0];
  budget -= cost;
  hireStatusElem.textContent =
    `${ROLES[fired.role].label}ï¼ˆ${wageLabel(fired.wage)}ï¼‰ã‚’è§£é›‡ã—ã¾ã—ãŸï¼ˆã‚³ã‚¹ãƒˆ50ï¼‰ã€‚`;
  updateUI();
});

// --- ä¼šç¤¾ã‚¿ã‚¤ãƒ—è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ ---
function diagnoseCompanyType(stats, caps) {
  if (caps.totalSales >= 5 && caps.backOfficeCount < 2) {
    return "æˆé•·ç‰¹åŒ–å‹ï¼ˆæ”»ã‚ã®å–¶æ¥­é‡è¦–ï¼‰";
  }
  if (caps.backOfficeCount >= 4 && caps.totalSales < 3) {
    return "å®‰å®šé‡è¦–å‹ï¼ˆç®¡ç†ä½“åˆ¶ä¸‡å…¨ï¼‰";
  }
  if (caps.totalSales >= 3 && caps.backOfficeCount >= 2) {
    return "ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆåˆ†æ¥­ã¨è£œå®Œæ€§ãŒæ©Ÿèƒ½ï¼‰";
  }
  return "è©¦è¡ŒéŒ¯èª¤å‹ï¼ˆçµ„ç¹”æ§‹ç¯‰ã®é€”ä¸Šï¼‰";
}

// --- ã‚¹ã‚³ã‚¢å±¥æ­´ ---
function loadScoreHistory() {
  const data = localStorage.getItem('orgsim_scores');
  if (!data) return [];
  try {
    const arr = JSON.parse(data);
    if (Array.isArray(arr)) {
      return arr.map(e =>
        typeof e === 'number'
          ? { score: e, year: 0, employees: 0, sales: 0, manufacturing: 0, backOffice: 0 }
          : e
      );
    }
    return [];
  } catch {
    return [];
  }
}
function saveScoreHistory(scores) {
  localStorage.setItem('orgsim_scores', JSON.stringify(scores));
}
function addScoreToHistory(score) {
  const stats = buildStats();
  const snapshot = {
    score,
    year: year - 1,
    employees: employees.length,
    sales: stats.sales.low + stats.sales.mid + stats.sales.high,
    manufacturing: stats.manufacturing.low + stats.manufacturing.mid + stats.manufacturing.high,
    backOffice:
      stats.accounting.low + stats.accounting.mid + stats.accounting.high +
      stats.legal.low + stats.legal.mid + stats.legal.high
  };

  const scores = loadScoreHistory();
  scores.push(snapshot);
  scores.sort((a, b) => b.score - a.score);
  while (scores.length > 5) scores.pop();
  saveScoreHistory(scores);
  return scores;
}
function renderScoreHistory(scores) {
  scoreHistoryList.innerHTML = '';
  if (scores.length === 0) {
    const li = document.createElement('li');
    li.textContent = 'ã‚¹ã‚³ã‚¢å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
    scoreHistoryList.appendChild(li);
    return;
  }

  const rankIcons = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "ğŸ–ï¸", "ğŸ–ï¸"];

  scores.forEach((entry, i) => {
    const li = document.createElement('li');
    li.style.cursor = 'pointer';
    li.textContent = `${rankIcons[i]} ${i + 1}ä½ï¼š${entry.score}`;

    li.addEventListener('click', () => {
      alert(
        `ã€å½“æ™‚ã®çµ„ç¹”æ§‹æˆã€‘\n` +
        `ãƒ»ãƒ—ãƒ¬ã‚¤å¹´æ•°ï¼š${entry.year}å¹´\n` +
        `ãƒ»å¾“æ¥­å“¡æ•°ï¼š${entry.employees}äºº\n` +
        `ãƒ»å–¶æ¥­ï¼š${entry.sales}äºº\n` +
        `ãƒ»è£½é€ ï¼š${entry.manufacturing}äºº\n` +
        `ãƒ»ç®¡ç†éƒ¨é–€ï¼š${entry.backOffice}äºº\n\n` +
        `ã“ã®çµ„ç¹”æ§‹æˆãŒã€ã‚¹ã‚³ã‚¢ ${entry.score} ã‚’ç”Ÿã¿ã¾ã—ãŸã€‚`
      );
    });

    scoreHistoryList.appendChild(li);
  });
}
const scoreHints = [
  "è£½é€ ã¨å–¶æ¥­ã®çµ„ã¿åˆã‚ã›ãŒå£²ä¸Šã‚’ä¼¸ã°ã—ã¾ã™",
  "æ³•å‹™ãƒ»çµŒç†ã¯ç›´æ¥åˆ©ç›Šã‚’ç”Ÿã¾ãªã„ãŒå®‰å®šæ€§ã‚’é«˜ã‚ã¾ã™",
  "é«˜è³ƒé‡‘ã¯å¸¸ã«æœ€é©ã¨ã¯é™ã‚‰ãªã„ãŒã€è¦æ‰€ã§ã¯é‡è¦ã§ã™",
  "åˆ†æ¥­ã¨è£œå®Œæ€§ãŒä¼æ¥­æˆæœã‚’æ±ºã‚ã¾ã™",
  "é«˜è³ƒé‡‘ã®äººæã¯ã€è‡ªèº«ã ã‘ã§ãªãå‘¨å›²ã®ç”Ÿç”£æ€§ã‚‚é«˜ã‚ã¾ã™"
];

function showGameOver() {
  gameOver = true;
  finalScoreElem.textContent = totalProfit;
  const stats = buildStats();
  const caps = computeCapabilities(stats);
  const companyType = diagnoseCompanyType(stats, caps);

  scoreHintElem.innerHTML =
    `ã‚ãªãŸã®ä¼šç¤¾ã‚¿ã‚¤ãƒ—ï¼š<strong>${companyType}</strong><br>
     äººæé…ç½®ã¨è³ƒé‡‘æˆ¦ç•¥ãŒã€ã“ã®çµæœã‚’ç”Ÿã¿ã¾ã—ãŸã€‚`;

  const scores = addScoreToHistory(totalProfit);
  renderScoreHistory(scores);
  gameOverElem.style.display = 'flex';
  updateUI();
}
function hideGameOver() {
  gameOverElem.style.display = 'none';
  gameOver = false;
  updateUI();
}

// --- ãƒªã‚»ãƒƒãƒˆå‡¦ç† ---
function resetGame() {
  year = 1;
  budget = 1000;
  profit = 0;
  totalProfit = 0;
  customerBase = 0;
  employees = [];
  hireStatusElem.textContent = '';
  eventLogElem.innerHTML = '';
  addLog('æ–°ã—ã„ä¼æ¥­çµŒå–¶ãŒå§‹ã¾ã£ãŸã€‚ã¾ãšã¯ã©ã‚“ãªçµ„ç¹”ã‚’ä½œã‚‹ã‹è€ƒãˆã‚ˆã†ã€‚', 'info');
  hideGameOver();
  updateUI();
  renderOrgPanel();
}
btnRestart.addEventListener('click', () => {
  resetGame();
});
btnResetScores.addEventListener('click', () => {
  localStorage.removeItem('orgsim_scores');
  renderScoreHistory([]);
});

// --- åˆæœŸã‚¹ã‚³ã‚¢å±¥æ­´è¡¨ç¤º ---
renderScoreHistory(loadScoreHistory());

// --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãƒ­ã‚¸ãƒƒã‚¯ ---
const startScreen = document.getElementById('startScreen');
const startGameBtn = document.getElementById('startGameBtn');
startGameBtn.addEventListener('click', () => {
  const durationInput = document.querySelector('input[name="duration"]:checked');
  MAX_YEAR = parseInt(durationInput.value, 10);
  startScreen.style.display = 'none';
  resetGame();
});

// --- çµ„ç¹”çŠ¶æ³ãƒ‘ãƒãƒ«æç”» ---
function renderOrgPanel() {
  // é›†è¨ˆ
  let roleCount = {};
  let wageCount = { low: 0, mid: 0, high: 0 };

  employees.forEach(e => {
    roleCount[e.role] = (roleCount[e.role] || 0) + 1;
    wageCount[e.wage]++;
  });

  // ã‚µãƒãƒªãƒ¼
  const totalWage = employees
    .filter(e => e.tenure >= 1)
    .reduce((s,e)=>s + wageCost(e.wage), 0);
  orgSummaryElem.textContent =
    `é¡§å®¢åŸºç›¤ ${customerBase} / å¾“æ¥­å“¡æ•° ${employees.length}äºº / å¹´é–“äººä»¶è²» ${totalWage}`;

  // è·ç¨®åˆ¥
  byRoleElem.innerHTML = '';
  Object.keys(roleCount).forEach(r => {
    const li = document.createElement('li');
    li.textContent = `${ROLES[r].label}: ${roleCount[r]}äºº`;
    byRoleElem.appendChild(li);
  });
  if (employees.length === 0) {
    byRoleElem.innerHTML = '<li>æœªæ¡ç”¨</li>';
  }

  // è³ƒé‡‘åˆ¥
  byWageElem.innerHTML = '';
  const wageLabels = {
    low: 'ä½è³ƒé‡‘ï¼ˆ50ï¼‰',
    mid: 'æ¨™æº–è³ƒé‡‘ï¼ˆ100ï¼‰',
    high: 'é«˜è³ƒé‡‘ï¼ˆ200ï¼‰'
  };
  Object.keys(wageCount).forEach(w => {
    const li = document.createElement('li');
    li.textContent = `${wageLabels[w]}: ${wageCount[w]}äºº`;
    byWageElem.appendChild(li);
  });

  // è§£é›‡å¯¾è±¡ãƒªã‚¹ãƒˆæ›´æ–°
  fireSelect.innerHTML = '';
  employees.forEach((e, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = `${ROLES[e.role].label}ï¼ˆ${wageLabel(e.wage)}ï¼‰`;
    fireSelect.appendChild(opt);
  });
  if (employees.length === 0) {
    const opt = document.createElement('option');
    opt.textContent = 'è§£é›‡å¯¾è±¡ãªã—';
    fireSelect.appendChild(opt);
  }

  // --- è·ç¨®Ã—è³ƒé‡‘ è¡¨ ---
  roleWageTableBody.innerHTML = '';
  Object.keys(ROLES).forEach(role => {
    const tr = document.createElement('tr');

    const low = employees.filter(e => e.role === role && e.wage === 'low').length;
    const mid = employees.filter(e => e.role === role && e.wage === 'mid').length;
    const high = employees.filter(e => e.role === role && e.wage === 'high').length;

    tr.innerHTML = `
      <td>${ROLES[role].label}</td>
      <td style="text-align:center">${low}</td>
      <td style="text-align:center">${mid}</td>
      <td style="text-align:center">${high}</td>
    `;
    roleWageTableBody.appendChild(tr);
  });
}

// åˆæœŸUI
updateUI();
})();
</script>

</body>
</html>